<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>虚拟内存知多少 | YounghBlog</title><meta name="keywords" content="虚拟内存,地址翻译"><meta name="author" content="Youngh"><meta name="copyright" content="Youngh"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="认识虚拟内存 虚拟内存是对主存和磁盘 I&#x2F;O 设备的抽象，是 CPU 与物理内存之间的一个中间层。 计算机系统提供了不同层次的抽象表示，以隐藏实际实现的复杂性：其中，操作系统是对硬件资源的抽象。 虚拟内存主要用来解决应用程序对内存需求日益增长的问题：现代物理内存的容量增长已经非常快了，但还是跟不上应用程序对主存需求的增长速度，即对于应用程序来说内存可能还是不够用，这就是虚拟内存出现的原因。 虚拟"><meta property="og:type" content="article"><meta property="og:title" content="虚拟内存知多少"><meta property="og:url" content="https://younghblog.gitee.io/posts/1869698891.html"><meta property="og:site_name" content="YounghBlog"><meta property="og:description" content="认识虚拟内存 虚拟内存是对主存和磁盘 I&#x2F;O 设备的抽象，是 CPU 与物理内存之间的一个中间层。 计算机系统提供了不同层次的抽象表示，以隐藏实际实现的复杂性：其中，操作系统是对硬件资源的抽象。 虚拟内存主要用来解决应用程序对内存需求日益增长的问题：现代物理内存的容量增长已经非常快了，但还是跟不上应用程序对主存需求的增长速度，即对于应用程序来说内存可能还是不够用，这就是虚拟内存出现的原因。 虚拟"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.gejiba.com/images/ec6056bb4a6e390d15c6bda5a67d6af3.md.webp"><meta property="article:published_time" content="2022-05-26T02:42:34.000Z"><meta property="article:modified_time" content="2022-09-25T02:09:04.540Z"><meta property="article:author" content="Youngh"><meta property="article:tag" content="虚拟内存"><meta property="article:tag" content="地址翻译"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.gejiba.com/images/ec6056bb4a6e390d15c6bda5a67d6af3.md.webp"><link rel="shortcut icon" href="https://cdn1.tianli0.top/gh/exploreMeta/cdn/img/logo/favicon.ico"><link rel="canonical" href="https://younghblog.gitee.io/posts/1869698891"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="https://jokerdig.com/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.0.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn1.tianli0.top/npm/flickr-justified-gallery@2/dist/fjGallery.min.js",css:"https://cdn1.tianli0.top/npm/flickr-justified-gallery@2/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"虚拟内存知多少",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-09-25 10:09:04"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){if(0!==a){a*=864e5,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t))}},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=e=>new Promise((t,a)=>{const o=document.createElement("script");o.src=e,o.async=!0,o.onerror=a,o.onload=o.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(o.onload=o.onreadystatechange=null,t())},document.head.appendChild(o)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")},"dark"===(e=saveToLocal.get("theme"))?activateDarkMode():"light"===e&&activateLightMode(),void 0!==(e=saveToLocal.get("aside-status"))&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside")),/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/gh/exploreMeta/cdn/css/index.min.css"><link rel="stylesheet" href="https://jokerdig.com/css/index.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/gh/exploreMeta/cdn/css/haa.css"><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/rss2.xml" title="YounghBlog" type="application/rss+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/3cb1dc95c490420f129fb73888c41e12.md.webp" onerror='onerror=null,src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://img.gejiba.com/images/ec6056bb4a6e390d15c6bda5a67d6af3.md.webp)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">YounghBlog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">虚拟内存知多少</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-26T02:42:34.000Z" title="发表于 2022-05-26 10:42:34">2022-05-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-25T02:09:04.540Z" title="更新于 2022-09-25 10:09:04">2022-09-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-CSAPP/">读书笔记 - CSAPP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>12分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="认识虚拟内存"><a class="markdownIt-Anchor" href="#认识虚拟内存"></a> 认识虚拟内存</h2><p>虚拟内存是对主存和磁盘 I/O 设备的抽象，是 CPU 与物理内存之间的一个中间层。</p><p class="div-border white left right" style="border:1px solid #03a9f4;border-left-style:solid;border-left-width:5px;border-right-style:solid;border-right-width:5px">计算机系统提供了不同层次的抽象表示，以隐藏实际实现的复杂性：<br><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/a8a67beaae798f3f562ff3c5e9048046.webp" alt="abstract" style="zoom:35%"><br>其中，操作系统是对硬件资源的抽象。</p><p>虚拟内存主要用来解决应用程序对内存需求日益增长的问题：现代物理内存的容量增长已经非常快了，但还是跟不上应用程序对主存需求的增长速度，即对于应用程序来说内存可能还是不够用，这就是虚拟内存出现的原因。</p><p>虚拟内存为每个进程提供了一个大的、一致的且私有的地址空间，同时提供了三个非常重要的能力：</p><ol><li>缓存机制。将主存看做磁盘的缓存，主存中只保留活动区域，并根据需要在主存和磁盘之间来回传送数据，从而使主存得到了高效的利用。</li><li>内存管理。为每个进程提供了一致的地址空间，从而简化了内存管理。</li><li>进程保护。每个进程的地址空间都是私有的，不会被其他进程破坏。</li></ol><h2 id="虚拟页"><a class="markdownIt-Anchor" href="#虚拟页"></a> 虚拟页</h2><p><span class="p red"><b>从概念上来说，虚拟内存是存放在磁盘上的一个地址连续的数组。</b></span>数组索引是虚拟地址，数组中的内容被缓存在主存中。</p><p>虚拟内存与物理内存之间以页为单位传送数据。虚拟内存中的页称为 <strong>虚拟页</strong>，物理内存中的页称为 <strong>物理页</strong>，物理页也叫 <strong>页帧</strong> 或 <strong>页框</strong>（page frame）。</p><p>虚拟页一共有三种状态：</p><ol><li><strong>未分配</strong>：磁盘中还没有任何数据与之相关联。</li><li><strong>已缓存</strong>：已分配，并且已经缓存在了物理内存中。</li><li><strong>未缓存</strong>：已分配，但尚未缓存在物理内存中。</li></ol><p><span class="p red"><b>从实现上来说，虚拟内存只是存放在内存中的一个数据结构。</b></span></p><p>进程执行前需要先装载，由于装载时已经建立了虚拟空间与可执行文件的映射关系，所以对于可执行文件中的任意虚拟页的访问，只会有缓存和未缓存两种状态。</p><p>未分配状态指的是磁盘中的空闲内存，可以通过内存分配函数（如 malloc）进行申请。</p><p>虚拟页往往很大，通常是 4KB ~ 2MB，这主要是因为主存的不命中处罚很大（主存不命中时访问磁盘的时间较长），为了补偿这些较长的访问时间，倾向于使用较大的数据块。并且由于大的不命中处罚，DRAM 缓存是全相联的，即任何虚拟页都可以放置在任何物理页中。</p><h2 id="页表"><a class="markdownIt-Anchor" href="#页表"></a> 页表</h2><p>如何判断一个虚拟页是否缓存到了 DRAM 中，以及缓存到了 DRAM 中的哪个物理页呢？除了需要依靠操作系统和 MMU 的支持外，还有一个非常重要的数据结构就是 <strong>页表</strong>。</p><p>每个进程都有自己的页表，页表保存在物理内存中，负责将虚拟页映射到物理页。每次 MMU 要将一个虚拟地址转换为物理地址时，都会读取页表。页表中的内容是由操作系统维护的。</p><p>页表中的每一项都是一个页表条目（Page Table Entry，PTE），每个虚拟页都会对应一个 PTE。这里先假设每个 PTE 只由 1 个有效位和 1 个 n 位地址字段组成。</p><p>有效位为 1 表示相应虚拟页被缓存到了物理内存中，而后面的地址字段就是相应物理页的地址。</p><p>如果有效位为 0，则表示相应虚拟页尚未缓存（地址字段指向该虚拟页在磁盘上的地址）或尚未分配（地址字段为空）。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/1f533acea037920622ed8aae9cf30c54.webp" alt="页表" style="zoom:35%"><p>上图展示了 8 个虚拟页和 4 个物理页所对应的页表。有 4 个虚拟页被缓存在了物理内存中，因此页表中对应项的有效位为 1，并且地址指向物理页；VP0 和 VP5 尚未分配，因此页表中对应项的有效位为 0，地址为空；VP3 和 VP6 已分配但尚未缓存，因此页表中对应项的有效位为 0，地址指向磁盘中的虚拟页。</p><h2 id="缺页"><a class="markdownIt-Anchor" href="#缺页"></a> 缺页</h2><p>对于已缓存的虚拟页可以直接命中，这种情况比较简单，这里重点看一下对于未缓存的虚拟页所导致的页不命中的情况，即缺页。</p><p>如图，CPU 要访问 VP3，但其并未缓存在 DRAM 中。此时 MMU 从页表中读取 PTE3，从有效位推断出 VP3 未被缓存，于是便触发了缺页异常。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/5f5f928b95feb1ea1eb5aa38a898238e.webp" alt="BeforePageFault" style="zoom:35%"><p>缺页异常会调用内核中相应的处理程序，从物理页中选择一个牺牲页（比如 VP4），用来存放 VP3。如果 VP4 已被修改，那么内核会将其写回磁盘。</p><p>接下来异常处理程序会根据 PTE 中的地址字段从磁盘中找到 VP3，将其复制到内存中的 PP3 位置，然后建立起虚拟页与物理页的映射关系并返回。此时 CPU 会重新执行导致缺页的那条指令，将虚拟地址重新发送到 MMU，此时就能够正常命中了，如图：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/f4197667bc9721f172fe9fa89508984a.webp" alt="AfterPageFault" style="zoom:35%"><h2 id="分配页面"><a class="markdownIt-Anchor" href="#分配页面"></a> 分配页面</h2><p>对于未分配的虚拟页，看一下其分配过程。</p><p>例如 VP5 尚未分配，当调用诸如 malloc 之类的分配函数时，会先在磁盘上分配空间，然后更新页表项 PTE5，使其指向磁盘中新创建的页，这时该虚拟页就从未分配变成了未缓存状态：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/22b521b7beef951628c4e3dea87d7ce5.webp" alt="allocate" style="zoom:35%"><h2 id="内存保护"><a class="markdownIt-Anchor" href="#内存保护"></a> 内存保护</h2><p>我们前面提到了页表中每个 PTE 由 1 个有效位和 1 个 n 位地址字段组成，事实上远不止这些。为了控制对内存系统的访问，这里再介绍 3 个额外的许可位：</p><ul><li><code>SUP</code>：表示内核（超级用户）模式。运行在内核模式的进程可以访问任何页面，而运行在用户模式的进程只能访问 <code>SUP</code> 为 0 的页面。</li><li><code>READ</code>：控制对页面的读访问权限。</li><li><code>WRITE</code>：控制对页面的写访问权限。</li></ul><p>通过这些许可位就可以控制一个用户进程不能修改其只读代码段，不能读写内核中的代码和数据段，不能读写其他进程的私有内存，不能修改与其他进程共享的虚拟页面（除非其他共享者都显式地允许它这么做），从而起到了 <strong>内存保护</strong> 的作用。</p><p>如果指令违反了这些许可条件，例如修改一个只读代码段，CPU 就会触发保护机制，在 Linux 中会报段错误（segmentation fault）。</p><h2 id="地址翻译"><a class="markdownIt-Anchor" href="#地址翻译"></a> 地址翻译</h2><p>了解了虚拟页、物理页和页表之后，再来看一下 <strong>地址翻译</strong>，即 MMU 是如何通过页表将虚拟地址映射到物理地址的：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/7c8774365c01d601e434fe57a33bc6a6.webp" alt="地址翻译" style="zoom:30%"><p>其中 <strong>页表基址寄存器</strong> 指向当前页表。MMU 根据虚拟页号找到相应的 PTE，再根据物理页号与虚拟地址中的偏移量就可以得到相应的物理地址。</p><p>MMU 根据虚拟页号查找 PTE 时，有页命中和页不命中两种情况。当该 PTE 的有效位为 1 时页命中，为 0 时页不命中。</p><p>当页命中时：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/f1b0706b7c81b38995c443f6ba08c05d.webp" alt="PTHit" style="zoom:25%"><p>当页不命中时：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/d44d25a093d0442c932ab25deea267aa.webp" alt="PTMiss" style="zoom:25%"><p>为了方便理解，上图将高速缓存和内存放到一起进行表示，二者之间的实际交互关系如下：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/073cdfdb3c2973603fd4546938322501.webp" alt="cache&dram" style="zoom:30%"><p>可以发现，CPU 每产生一个虚拟地址，MMU 就必须进行一次访存操作，即查阅 PTE 将虚拟地址转换为物理地址。在最坏情况下，内存中也没有该页表项，这时就需要从磁盘换入该 PTE，然后 MMU 再额外进行一次访存操作。而在最好情况下，该 PTE 恰好缓存在 L1 Cache，那么访存开销就只有 1~2 个周期，而即便是这样的开销，很多系统也仍会试图消除它，具体做法就是在 MMU 中增加一个 PTE 的缓存，即 TLB。</p><h2 id="tlb"><a class="markdownIt-Anchor" href="#tlb"></a> TLB</h2><p>TLB（Translation Lookaside Buffer），俗称快表，是一个小的、虚拟寻址的缓存。为了通过虚拟地址寻找 TLB 中的项（TLB 是组相联或全相联的），将虚拟地址的虚拟页号（VPN）进一步划分为 TLB 的标记位（TLBT）和组索引位（TLBI），如图所示：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/b7c9f89274715cefa3afc2b1ea971fe9.webp" alt="VA" style="zoom:30%"><p>TLB 通常有高度的相联度，每一行都缓存了 PTE 的内容。并且由于是在 MMU 中，因此地址翻译非常快。</p><p>当 TLB 命中时：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/4bf7ca2feda8831061d108d2cc7855db.webp" alt="TLBHit" style="zoom:30%"><p>当 TLB 不命中时：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/93e15328ed4c3497365420ceed176acd.webp" alt="TLBMiss" style="zoom:30%"><h2 id="多级页表"><a class="markdownIt-Anchor" href="#多级页表"></a> 多级页表</h2><p>到现在为止，我们一直假设系统只用一个单独的页表来进行地址翻译，但这显然是不现实的。我们可以计算一下：对于一个 32 位地址空间的系统，页大小为 4KB，一个页表项是 4 个字节，那么这个页表有多大？</p><blockquote><ul><li><p>32 位地址空间 <span class="p red"><b>→</b></span> 地址总数是2<sup>32</sup> ，而每个地址对应的内存空间为 1 B，所以最大内存空间为 2<sup>32</sup> B</p></li><li><p>4 KB 的页 <span class="p red"><b>→</b></span> 即页大小为 2<sup>12</sup> B <span class="p red"><b>→</b></span> 总页数为 2<sup>32</sup> B / 2<sup>12</sup> B = 2<sup>20</sup></p></li><li><p>4 B 的页表项 <span class="p red"><b>→</b></span> 即页表项大小为 2<sup>2</sup> B，而一个页表项对应一个页，所以有 2<sup>20</sup> 个页就需要有相同数量的页表项 <span class="p red"><b>→</b></span> 页表大小 = 页表项数 x 页表项大小 = 2<sup>20</sup> x 2<sup>2</sup> B = 4 x 2<sup>20</sup> B = 4 MB</p></li></ul><p class="div-border blue left right">2<sup>30</sup> B = 1 GB<br>2<sup>20</sup> B = 1 MB<br>2<sup>10</sup> B = 1 KB</p></blockquote><p>由此可知，在内存中必须驻留一个 4MB 大小的页表，即使该程序只用到了虚拟地址空间中很小的一部分。对于 64 位的系统来说，页表会更大。</p><p>为了压缩页表，常用的方法就是使用 <strong>多级页表</strong>。还是上面的例子，一个 4MB 的页表映射了 4GB 的空间，如果我们使用两级页表，那么效果会是什么样呢？</p><p>将这个独立的页表拆分成 1024 个等大小的页表，那么每个页表的大小为 4MB / 1024 = 4 KB，每个 4KB 的页表能够映射 4KB / 4B * 4KB = 4MB 的虚拟地址空间，这段空间我们称其为 <strong>片</strong>（chunk）。</p><p>为了管理这 1024 个页表，还需要一个页表，这里将其称为 <strong><span class="p red">一级页表（也叫页目录）</span></strong>，相应地这 1024 个页表就叫二级页表。一级页表中一个页表项对应一个二级页表，因此一级页表就有 1024 个页表项，于是一级页表的大小为 1024 * 4B = 4KB。</p><p>可以发现，一级页表和每个二级页表大小都是 4KB，刚好是一个页的大小。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="" alt="2levelPT" style="zoom:40%"><p>如果某个片中每个虚拟页均未分配，那么相应的一级页表项就为空（片2~7），自然也不需要二级页表了。多级页表从两个方面缓解了对内存的需求：</p><ul><li>如果一级页表为空，那么相应的二级页表根本就不会存在。这代表着一种巨大的潜在节约，因为对于一个典型的程序来说，4GB 的虚拟地址空间中大部分虚拟页都是未分配的。</li><li>只有一级页表和经常使用的二级页表才需要缓存在主存中，其他二级页表只在必要时换入换出，这就大大减少了主存的压力。</li></ul><p>当使用了 k 级页表之后，进行地址翻译时虚拟地址中的虚拟页号会被划分成 k 个：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/a2b7aa48456b24f6f8be5fd722fbfc07.webp" alt="klevelPT" style="zoom:28%"><p>在前 k - 1 级页表中，每个 PTE 都指向下一级页表的基地址，第 k 级页表中的 PTE 则包含了某个物理页的页号，或者某个磁盘块的地址。为了构造出物理地址，MMU 必须访问 k 个页表。</p><div class="note quote flat"><p>事实上，多级页表的地址翻译并不会比单页表慢很多。</p></div><p>以 Core i7 为例，看一下完整的地址翻译过程。</p><p>Core i7 采用四级页表的层次结构，CR3 寄存器保存了一级页表的基地址。CR3 的值是每个进程上下文的一部分，每次进程上下文切换时，CR3 的值都会被保存和恢复。</p><p>Core i7 的内存系统如下：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/b7450e2a058a179082ebcac570771477.webp" alt="corei7mem" style="zoom:40%"><p>地址翻译过程如下：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/1be6c26ad41cec6488e280cbddcc30d3.webp" alt="corei7addtranslation" style="zoom:40%"><h2 id="linux-虚拟内存系统"><a class="markdownIt-Anchor" href="#linux-虚拟内存系统"></a> Linux 虚拟内存系统</h2><p>Linux 进程的虚拟内存空间如下图，我们已经很熟悉了。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/b3d458042407463af9d69dfab0d3a6d1.webp" alt="Linux进程的虚拟内存空间" style="zoom:60%"><p>Linux 将虚拟内存组织为区域（area，也叫段）的集合，每个区域实际上都是一个数据结构。内核为系统中的每个进程都维护了一个任务结构 <code>task_struct</code>，其中包含了运行该进程所需的所有信息，例如 PID、PC、栈指针、可执行文件的名字等等。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/0c09cdfb806b3ec4eec728948ddeeee9.webp" alt="vmas"></p><p><code>task_struct</code> 的其中一个成员 <code>mm</code> 指向 <code>mm_struct</code>，它描述了虚拟内存的当前状态。其中 <code>pgd</code>（page global directory，页目录）指向页目录的基地址，当内核运行该进程时会将其存放在 CR3 控制寄存器中；<code>mmap</code> 则指向 <code>vm_area_struct</code> 链表。</p><p>每个 <code>vm_area_struct</code> 都描述了当前虚拟地址空间的一个区域，其中各字段的含义已在图中标出。</p><p>当 MMU 翻译某个虚拟地址时发生了缺页，缺页处理程序将会执行以下步骤：</p><ol><li>判断该虚拟地址是否合法，即是否在某个区域的地址范围内。此时需要比较该虚拟地址与每个区域结构的 <code>vm_start</code> 和 <code>vm_end</code>，如果不合法，则会触发 <strong>段错误</strong>，如图中 ① 所示，从而终止进程。</li><li>判断该内存访问是否合法，即进程是否有读、写或执行该区域的权限。如果不合法，比如要对只读代码段进行写操作，则会触发 <strong>保护异常</strong>，如图中 ② 所示，从而终止进程。</li><li>此时便可以确定该缺页是由于合法的虚拟地址进行合法的内存访问所造成的。处理缺页的过程为：选择一个牺牲页（如果没有空白页的话），如果被修改过则需要写回磁盘，然后换入新的物理页并更新页表。当缺页处理程序返回时，CPU 重新执行引起缺页的指令，此时就可以正常翻译了。</li></ol><h2 id="内存映射"><a class="markdownIt-Anchor" href="#内存映射"></a> 内存映射</h2><p>前面在介绍 <a href="#%E8%99%9A%E6%8B%9F%E9%A1%B5">虚拟页</a> 的时候，我们提到了当可执行文件被装载时，会建立虚拟地址空间与可执行文件的映射关系，这实际上就是内存映射。</p><p>Linux 通过将一个虚拟内存区域与一个磁盘上的对象关联起来，以初始化该虚拟内存区域中的内容，这个过程称为 <strong>内存映射</strong>。可以映射的磁盘文件有两种类型：</p><ol><li>普通文件。文件中保存了初始化的内容，例如可执行目标文件。页面按需调度，直到发生缺页时才会换入物理内存。如果换入之后没有填满该区域，则用零来填充剩余部分。</li><li><strong>匿名文件</strong>。文件中保存的都是二进制零，由内核创建。当虚拟内存空间映射到该区域时，并不需要在磁盘和内存之间进行数据传送，只需用零覆盖即可。因此，映射到匿名文件的页有时也叫 <strong>请求二进制零的页</strong>。</li></ol><p>无论哪种情况，一旦一个虚拟页与磁盘中的文件完成了内存映射，它就会在由内核维护的交换空间与物理内存之间换入换出。</p><p class="div-border blue left"><b>交换空间</b> 是磁盘上的一块区域，当物理内存吃紧时，会将内存中不常访问的数据换出到该区域，这样系统就有了更多的物理内存为各进程服务。当需要访问交换空间中存储的内容时，再将其换入到物理内存中。因此，<span class="p red"><b>交换空间限制了当前进程所能分配的虚拟页的总数。</b></span></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="https://younghblog.gitee.io">Youngh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://younghblog.gitee.io/posts/1869698891.html">https://younghblog.gitee.io/posts/1869698891.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://younghblog.gitee.io" target="_blank">YounghBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/">虚拟内存</a><a class="post-meta__tags" href="/tags/%E5%9C%B0%E5%9D%80%E7%BF%BB%E8%AF%91/">地址翻译</a></div><div class="post_share"><div class="social-share" data-image="https://img.gejiba.com/images/ec6056bb4a6e390d15c6bda5a67d6af3.md.webp" data-sites="weibo,wechat,qq"></div><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn1.tianli0.top/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn1.tianli0.top/gh/exploreMeta/cdn/img/donate/wechat.webp" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn1.tianli0.top/gh/exploreMeta/cdn/img/donate/wechat.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn1.tianli0.top/gh/exploreMeta/cdn/img/donate/alipay.webp" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn1.tianli0.top/gh/exploreMeta/cdn/img/donate/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2281565213.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/ed0f3f7a012e4718162c75786caa867b.md.webp" onerror='onerror=null,src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">温故而知新</div></div></a></div><div class="next-post pull-right"><a href="/posts/2065420180.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/ec6056bb4a6e390d15c6bda5a67d6af3.md.webp" onerror='onerror=null,src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">高速缓存是如何查找数据的</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/3cb1dc95c490420f129fb73888c41e12.md.webp" onerror='this.onerror=null,this.src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="avatar"></div><div class="author-info__name">Youngh</div><div class="author-info__description">Stay hungry, stay foolish</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/younghblog"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=1413483899" target="_blank"><i class="fa-brands fa-qq"></i></a><a class="social-icon" href="mailto:1413483899@qq.com" target="_blank"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="/rss2.xml" target="_blank"><i class="fa-solid fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>O.O</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">认识虚拟内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E9%A1%B5"><span class="toc-number">2.</span> <span class="toc-text">虚拟页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B5%E8%A1%A8"><span class="toc-number">3.</span> <span class="toc-text">页表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%BA%E9%A1%B5"><span class="toc-number">4.</span> <span class="toc-text">缺页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.</span> <span class="toc-text">分配页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BF%9D%E6%8A%A4"><span class="toc-number">6.</span> <span class="toc-text">内存保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E7%BF%BB%E8%AF%91"><span class="toc-number">7.</span> <span class="toc-text">地址翻译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tlb"><span class="toc-number">8.</span> <span class="toc-text">TLB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8"><span class="toc-number">9.</span> <span class="toc-text">多级页表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F"><span class="toc-number">10.</span> <span class="toc-text">Linux 虚拟内存系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84"><span class="toc-number">11.</span> <span class="toc-text">内存映射</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/2031896266.html" title="Binder机制"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/3d23f7fc9501aa22402a02666b09e892.md.webp" onerror='this.onerror=null,this.src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="Binder机制"></a><div class="content"><a class="title" href="/posts/2031896266.html" title="Binder机制">Binder机制</a><time datetime="2022-09-25T01:08:18.000Z" title="发表于 2022-09-25 09:08:18">2022-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2872386792.html" title="JNI学习"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/788496e432e69da44ecda3baa70659f5.md.webp" onerror='this.onerror=null,this.src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="JNI学习"></a><div class="content"><a class="title" href="/posts/2872386792.html" title="JNI学习">JNI学习</a><time datetime="2022-09-21T15:15:22.000Z" title="发表于 2022-09-21 23:15:22">2022-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3659942439.html" title="Android渲染的整体架构"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/eb8d19563d07ccc303ce96f0da4a25af.md.webp" onerror='this.onerror=null,this.src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="Android渲染的整体架构"></a><div class="content"><a class="title" href="/posts/3659942439.html" title="Android渲染的整体架构">Android渲染的整体架构</a><time datetime="2022-09-04T13:11:29.000Z" title="发表于 2022-09-04 21:11:29">2022-09-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1441608745.html" title="「高效能人士的七个习惯」读书笔记"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/b60a19efb0970a66b87460015b04961c.md.webp" onerror='this.onerror=null,this.src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="「高效能人士的七个习惯」读书笔记"></a><div class="content"><a class="title" href="/posts/1441608745.html" title="「高效能人士的七个习惯」读书笔记">「高效能人士的七个习惯」读书笔记</a><time datetime="2022-07-08T12:39:21.000Z" title="发表于 2022-07-08 20:39:21">2022-07-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1980352382.html" title="「关键对话」读书笔记"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.gejiba.com/images/e23ded29a0c8c46be41bcbaf31ecec1f.md.webp" onerror='this.onerror=null,this.src="https://img.gejiba.com/images/4f60b4e053a96873d937752732c06a09.gif"' alt="「关键对话」读书笔记"></a><div class="content"><a class="title" href="/posts/1980352382.html" title="「关键对话」读书笔记">「关键对话」读书笔记</a><time datetime="2022-07-01T14:42:30.000Z" title="发表于 2022-07-01 22:42:30">2022-07-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022&nbsp;&nbsp;&nbsp;<i style="color:#ff6a6a;animation:announ_animation .8s linear infinite" class="fas fa-heart"></i>&nbsp;&nbsp;&nbsp;By Youngh</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="https://www.antmoe.com/js/utils.js"></script><script src="https://www.antmoe.com/js/main.js"></script><script src="https://cdn1.tianli0.top/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://cdn.staticfile.org/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://www.antmoe.com/js/search/local-search.js" defer></script><div class="js-pjax"><script>function loadValine(){function n(){new Valine(Object.assign({el:"#vcomment",appId:"fUqvuCwXzFgVcGgakVuftjjg-gzGzoHsz",appKey:"44H71E23JXOW8dMVSkYGsmAG",avatar:"monsterid",serverURLs:"",emojiMaps:"",path:window.location.pathname,visitor:!1},null))}"function"==typeof Valine?n():getScript("https://cdn1.tianli0.top/npm/valine/dist/Valine.min.js").then(n)}function loadOtherComment(){loadValine()}btf.loadComment(document.getElementById("vcomment"),loadValine)</script></div><script src="https://cdn1.tianli0.top/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script id="click-heart" src="https://cdn1.tianli0.top/npm/butterfly-extsrc@1/dist/click-heart.min.js" async mobile="false"></script><script src="https://cdn.casecori.top/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.tocScrollFn&&window.removeEventListener("scroll",window.tocScrollFn),window.scrollCollect&&window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),document.getElementById("rightside").style.cssText="opacity: ''; transform: ''",window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script");var o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script></div></body></html>